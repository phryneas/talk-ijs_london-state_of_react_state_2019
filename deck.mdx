import { Head, Notes, Image, Appear, Slide, Pre } from "@mdx-deck/components";
import { Split } from "@mdx-deck/layouts";

import { default as theme } from "./theme";
import highlight from "@mdx-deck/themes/syntax-highlighter-prism";
import { Fragment } from "react";

export const themes = [theme, highlight];

<Image
  src={require("file-loader!./assets/iJS_London_2018_Template_1920x1080_49699_v1a.webp")}
  style={{ position: "absolute", top: 0, left: 0 }}
/>

---

# About me

<ul>
  <li>
    Lenz Weber (<em>@phry</em> on Twitter, <em>phryneas</em> everywhere else)
  </li>
  <li>
    Developer at
    <img
      src="./assets/mayflower_logo_transparent.png"
      lang="typescript"
      style={{
        height: "1.3em",
        verticalAlign: "bottom",
        position: "relative",
        top: "5px",
        left: "-5px"
      }}
    />
  </li>
  <li>Working in professional web development since 15 years</li>
  <li>Working with React since 2016</li>
  <li>In love with the Web, Open Source, Linux and Security</li>
</ul>

---

# Why this Talk?

<Appear>
  <blockquote>
    ‚ÄúHere's just how to use Redux‚Äù
    <cite>80% of all tutorials on React state management</cite>
  </blockquote>
  <blockquote>
    ‚ÄúI hope that with the new context API less people will use Redux because
    they need a global subscription mechanism, and more because they actually
    need Redux.‚Äù
    <cite>
      <a href="https://twitter.com/dan_abramov/status/958070783473045504">
        Dan Abramov on Twitter
      </a>
    </cite>
  </blockquote>
  <blockquote>
    ‚ÄúRedux is dead!‚Äù
    <cite>too many blogposts</cite>
  </blockquote>
  <blockquote>
    ‚ÄúI just use MobX, it's much more simple‚Äù
    <cite>random person on reddit</cite>
  </blockquote>
  <blockquote>
    ‚ÄúLet's just use graphql for everything‚Äù
    <cite>the Hypetrain</cite>
  </blockquote>
  <blockquote>
    ‚ÄúI feel like I should make a workshop: "How to migrate from redux to
    useReducer/useContext" [...]
    <cite>
      <a href="https://twitter.com/kentcdodds/status/1118248491510222848">
        Kent C Dodds on Twitter
      </a>
    </cite>
  </blockquote>
  <blockquote>
    ‚ÄúAdd hooks!‚Äù
    <cite>the Hypetrain, again</cite>
  </blockquote>

<h2>This is confusing!</h2>

</Appear>

---

# A brief warning:

## This talk might already be outdated...

Especially third-party-library hooks APIs mentioned in this talk are all alpha and subject to change (and they do!)

---

# We need to look at:

- Different types of State in React Apps
- Common options for State management
- What kind of management to use for what kind of state

---

# Different types of State in React Apps

- configuration (language, theme etc.)
- login/user information
- input/form State
- UI State (toggles etc.)
- API Cache
- calculated values

---

# But first...

## What do we look at - and Why?

---

# State Types

<Split>

## What

## Why

</Split>

<Split>
<Fragment>

- global
- semi-global
- semi-local
- local

</Fragment>

<Fragment>

- more global state
  - easy to see application state at one glance
  - difficult to attribute accountability
  - might trigger re-rendering of a lot of Components
- more local state
  - difficult to get "the big picture"
  - clear responsibilites

</Fragment>

</Split>

<Notes>

- _global_: the whole application depends on it
- _semi-global_: large parts of the application depend on it
- _semi-local_: one small component tree depends on it
- _local_: only one component depends on it

"accountability" comment:

- what triggers state changes
- which team is responsible

"big picture" comment:

- no time travel etc

</Notes>

---

# How often does a State change

## Why

State that impacts a lot of Components AND changes often might lead to performance problems.

---

# How is it initialized

<Split>

## What

## Why

</Split>

<Split>

<Fragment>

- no initialization
- default values
- values from storage
- values from asynconous sources
- derived when it is first required

</Fragment>

<Fragment>

Sometimes State initialization should be triggered before the App starts rendering. This might affect your choice of state management solution.

</Fragment>

</Split>

---

# How State updates are triggered

<Split>

## What

## Why

</Split>

<Split>

<Fragment>

- Application Lifecycle
- Component Lifecycle
- User Interaction

* synchronously or asynchronously

</Fragment>

<Fragment>

This might impact your choice of State management.

Not every of these combinations is easily possible with every solution.

</Fragment>

</Split>

---

# Configuration (language, theme etc.)

- affects almost all of your Components
- this is _true global state_
- changes _rarely_
- usually initialized _from storage_
- changes are triggered _from somewhere in the Component tree_

---

# User authentication State

- used in some Components, in different parts of your applications
- most likely, you even use this state outside of React
- this is _true global state_
- changes _rarely_
- usually initialized _from storage_
- changes are triggered _asynchronously_ through user interaction

---

# Input or form State

- contains:
  - user input
  - validation results
- while the form is displayed: _local state_
- final results of the user input might become relevant outside of this form
  - in that case, the result later becomes _global_ or _semi-global_
- changes _often_
- usually initialized with _default values_
- changes are triggered from a _close component_

---

# UI State (toggles etc.)

- usually _local state_
- if you want to keep some UI state while the component is not mounted, this becomes _semi-global_
- if a component might be rendered twice at the same time, this is definitely _local state_
  - in that case, storing it in a _semi-global_ fashion might require you to track _component state identity_
- usually initialized with _default values_
- changes are triggered from a _close component_

---

# API cache

- can be _global_ or _local_
- can contain denormalized or normalized values
- usually initialized _empty_
- changes are triggered _asynchronously_, with or without user interaction
- should get _invalidated_

---

# Calculated values

- derived values
- can always be recomputed using other values available to the Component
- only kept because computation is expensive
- usually _local_, sometimes _global_

---

# Let's get the elephant out of the room: Cache state

## If you use GraphQL

you won't have to worry about Cache

---

# Let's get the elephant out of the room: Cache state

## If you **don't** use GraphQL

- if you can keep your Cache for a part of your API local, this might be worth a try
  - Cache invalidation takes place as the component holding state is unmounted
- but as soon as two Components in different subtrees need access to the same API, you have to go global state or risk going out of sync
- there is no good library I know of to handle this in the REST world - you'll have to do your own and handle it like all your other global State
- this talk will not cover more on Cache State

---

# And something else... Form State

- managing Form state is not very much fun... but, there are good libraries for that!
- take a look at Formik or React-Final-Form for example

---

# What are we left with?

- highly depends on your applications
- usually:
  - not very much real global state
  - some semi-global state
  - a lot of local or semi-local state

## let's see how to approach such a scenario

---

# How far can we get with React alone?

From now on, we're in hooks & demo territory

<a href="https://codesandbox.io/s/oxm0q8x1ry?fontsize=14&module=%2Fsrc%2FExample1.js">
  <svg
    shape-rendering="crispEdges"
    height="300px"
    width="300px"
    viewBox="0 0 37 37"
  >
    <path fill="#FFFFFF" d="M0,0 h37v37H0z" />
    <path
      fill="#000000"
      d="M0 0h7v1H0zM9 0h1v1H9zM15 0h2v1H15zM18 0h1v1H18zM20 0h5v1H20zM26 0h1v1H26zM30,0 h7v1H30zM0 1h1v1H0zM6 1h1v1H6zM8 1h2v1H8zM11 1h2v1H11zM21 1h2v1H21zM27 1h2v1H27zM30 1h1v1H30zM36,1 h1v1H36zM0 2h1v1H0zM2 2h3v1H2zM6 2h1v1H6zM9 2h3v1H9zM14 2h1v1H14zM16 2h1v1H16zM19 2h3v1H19zM24 2h1v1H24zM27 2h2v1H27zM30 2h1v1H30zM32 2h3v1H32zM36,2 h1v1H36zM0 3h1v1H0zM2 3h3v1H2zM6 3h1v1H6zM8 3h2v1H8zM11 3h1v1H11zM16 3h2v1H16zM25 3h2v1H25zM30 3h1v1H30zM32 3h3v1H32zM36,3 h1v1H36zM0 4h1v1H0zM2 4h3v1H2zM6 4h1v1H6zM10 4h1v1H10zM12 4h4v1H12zM17 4h1v1H17zM20 4h2v1H20zM23 4h2v1H23zM26 4h1v1H26zM28 4h1v1H28zM30 4h1v1H30zM32 4h3v1H32zM36,4 h1v1H36zM0 5h1v1H0zM6 5h1v1H6zM8 5h1v1H8zM10 5h1v1H10zM13 5h4v1H13zM18 5h1v1H18zM22 5h1v1H22zM27 5h1v1H27zM30 5h1v1H30zM36,5 h1v1H36zM0 6h7v1H0zM8 6h1v1H8zM10 6h1v1H10zM12 6h1v1H12zM14 6h1v1H14zM16 6h1v1H16zM18 6h1v1H18zM20 6h1v1H20zM22 6h1v1H22zM24 6h1v1H24zM26 6h1v1H26zM28 6h1v1H28zM30,6 h7v1H30zM12 7h2v1H12zM15 7h1v1H15zM18 7h2v1H18zM21 7h1v1H21zM26 7h2v1H26zM0 8h5v1H0zM6 8h5v1H6zM12 8h1v1H12zM14 8h2v1H14zM17 8h1v1H17zM20 8h1v1H20zM22 8h2v1H22zM25 8h1v1H25zM28 8h2v1H28zM31 8h1v1H31zM33 8h1v1H33zM35 8h1v1H35zM1 9h2v1H1zM7 9h3v1H7zM15 9h2v1H15zM18 9h2v1H18zM23 9h4v1H23zM28 9h2v1H28zM31 9h1v1H31zM33 9h3v1H33zM2 10h5v1H2zM8 10h2v1H8zM11 10h2v1H11zM18 10h1v1H18zM20 10h3v1H20zM27 10h2v1H27zM31 10h4v1H31zM36,10 h1v1H36zM1 11h1v1H1zM3 11h1v1H3zM5 11h1v1H5zM8 11h4v1H8zM14 11h1v1H14zM16 11h1v1H16zM20 11h3v1H20zM28 11h1v1H28zM30 11h4v1H30zM35 11h1v1H35zM0 12h2v1H0zM6 12h3v1H6zM10 12h2v1H10zM16 12h2v1H16zM22 12h1v1H22zM24 12h3v1H24zM30 12h1v1H30zM32 12h3v1H32zM36,12 h1v1H36zM0 13h1v1H0zM2 13h1v1H2zM4 13h2v1H4zM9 13h1v1H9zM12 13h4v1H12zM17 13h3v1H17zM23 13h1v1H23zM25 13h2v1H25zM28 13h1v1H28zM31 13h1v1H31zM34 13h2v1H34zM3 14h1v1H3zM6 14h2v1H6zM10 14h1v1H10zM13 14h4v1H13zM20 14h1v1H20zM22 14h1v1H22zM24 14h1v1H24zM27 14h3v1H27zM32 14h1v1H32zM34,14 h3v1H34zM1 15h4v1H1zM7 15h2v1H7zM12 15h2v1H12zM15 15h1v1H15zM19 15h1v1H19zM21 15h4v1H21zM28 15h1v1H28zM33 15h1v1H33zM36,15 h1v1H36zM1 16h1v1H1zM6 16h2v1H6zM10 16h1v1H10zM12 16h1v1H12zM14 16h2v1H14zM17 16h1v1H17zM22 16h2v1H22zM25 16h1v1H25zM29 16h2v1H29zM32 16h3v1H32zM36,16 h1v1H36zM0 17h2v1H0zM7 17h1v1H7zM10 17h1v1H10zM15 17h2v1H15zM19 17h3v1H19zM23 17h1v1H23zM26 17h1v1H26zM31 17h1v1H31zM34 17h2v1H34zM0 18h1v1H0zM4 18h3v1H4zM8 18h1v1H8zM10 18h3v1H10zM18 18h1v1H18zM21 18h2v1H21zM27 18h1v1H27zM34,18 h3v1H34zM1 19h1v1H1zM4 19h2v1H4zM7 19h3v1H7zM11 19h1v1H11zM14 19h1v1H14zM16 19h1v1H16zM18 19h2v1H18zM21 19h1v1H21zM24 19h1v1H24zM26 19h6v1H26zM36,19 h1v1H36zM0 20h1v1H0zM2 20h1v1H2zM4 20h1v1H4zM6 20h1v1H6zM9 20h1v1H9zM11 20h1v1H11zM16 20h2v1H16zM20 20h1v1H20zM22 20h6v1H22zM29 20h2v1H29zM32,20 h5v1H32zM2 21h1v1H2zM5 21h1v1H5zM7 21h2v1H7zM10 21h1v1H10zM12 21h4v1H12zM17 21h7v1H17zM26 21h1v1H26zM28 21h1v1H28zM31 21h1v1H31zM33 21h1v1H33zM35 21h1v1H35zM0 22h2v1H0zM4 22h1v1H4zM6 22h2v1H6zM9 22h2v1H9zM13 22h4v1H13zM20 22h3v1H20zM25 22h1v1H25zM27 22h3v1H27zM32 22h1v1H32zM34,22 h3v1H34zM0 23h3v1H0zM4 23h2v1H4zM8 23h2v1H8zM12 23h2v1H12zM15 23h1v1H15zM18 23h2v1H18zM21 23h4v1H21zM27 23h3v1H27zM31 23h2v1H31zM36,23 h1v1H36zM0 24h1v1H0zM3 24h1v1H3zM5 24h2v1H5zM10 24h1v1H10zM12 24h1v1H12zM14 24h2v1H14zM17 24h1v1H17zM20 24h1v1H20zM22 24h1v1H22zM25 24h3v1H25zM30 24h1v1H30zM32,24 h5v1H32zM0 25h4v1H0zM5 25h1v1H5zM8 25h1v1H8zM10 25h1v1H10zM15 25h2v1H15zM18 25h3v1H18zM23 25h1v1H23zM25 25h2v1H25zM28 25h1v1H28zM31 25h1v1H31zM34 25h2v1H34zM0 26h1v1H0zM6 26h1v1H6zM10 26h3v1H10zM21 26h2v1H21zM24 26h1v1H24zM27 26h1v1H27zM29 26h1v1H29zM31 26h1v1H31zM34,26 h3v1H34zM0 27h1v1H0zM3 27h1v1H3zM7 27h1v1H7zM11 27h1v1H11zM14 27h1v1H14zM16 27h1v1H16zM19 27h3v1H19zM26 27h1v1H26zM29 27h1v1H29zM36,27 h1v1H36zM0 28h1v1H0zM2 28h2v1H2zM6 28h1v1H6zM8 28h1v1H8zM11 28h1v1H11zM17 28h2v1H17zM22 28h1v1H22zM25 28h1v1H25zM27 28h8v1H27zM8 29h3v1H8zM12 29h4v1H12zM20 29h2v1H20zM23 29h1v1H23zM25 29h4v1H25zM32 29h1v1H32zM0 30h7v1H0zM8 30h2v1H8zM13 30h4v1H13zM18 30h1v1H18zM21 30h2v1H21zM24 30h3v1H24zM28 30h1v1H28zM30 30h1v1H30zM32 30h2v1H32zM35,30 h2v1H35zM0 31h1v1H0zM6 31h1v1H6zM10 31h1v1H10zM12 31h2v1H12zM19 31h1v1H19zM21 31h3v1H21zM26 31h1v1H26zM28 31h1v1H28zM32 31h1v1H32zM35 31h1v1H35zM0 32h1v1H0zM2 32h3v1H2zM6 32h1v1H6zM8 32h2v1H8zM12 32h1v1H12zM14 32h5v1H14zM20 32h1v1H20zM23 32h13v1H23zM0 33h1v1H0zM2 33h3v1H2zM6 33h1v1H6zM8 33h2v1H8zM16 33h4v1H16zM22 33h2v1H22zM29 33h2v1H29zM32 33h1v1H32zM36,33 h1v1H36zM0 34h1v1H0zM2 34h3v1H2zM6 34h1v1H6zM8 34h1v1H8zM11 34h2v1H11zM15 34h1v1H15zM17 34h1v1H17zM20 34h3v1H20zM25 34h2v1H25zM28 34h1v1H28zM31 34h1v1H31zM35,34 h2v1H35zM0 35h1v1H0zM6 35h1v1H6zM8 35h4v1H8zM14 35h1v1H14zM18 35h1v1H18zM20 35h4v1H20zM27 35h6v1H27zM36,35 h1v1H36zM0 36h7v1H0zM8 36h1v1H8zM11 36h1v1H11zM17 36h1v1H17zM23 36h4v1H23zM29 36h2v1H29zM34,36 h3v1H34z"
    />
  </svg>
</a>

---

# Best practices

- Learn useReducer early - it's much more powerful than useState
- Lift your State up to a common Parent for related State, instead of keeping duplicate State in sync
- Prevent prop drilling by composing Components near the Component you lifted State up to - representational Components can just receive _children_
- If you get too much prop drilling, start using Context
- Use Context as low in your Component tree as possible - no need to move everything to the root

---

# Limitations of using only React

---

# Limitations of using only React

Having a lot of different/unrelated state in one often-subscribed Context Provider might cause many unnessary re-renders.

Splitting up that big Context Provider into smaller ones might lead to a Cascade of Context Providers.

---

# Limitations of using only React

Alternatively, you can keep just one Context Provider and handle _subscriptions_ yourself.

This will very likely lead to problems with the upcoming React Concurrent mode. This _will_ cause you pain.

---

# Limitations of using only React

You can't just "plug in" new Context Providers after your App starts rendering.

---

# Limitations of using only React

While performing an asynchronous action, there's no way to get the _current state_ like you could in most libraries through a middleware.

---

# So...

## These limitations don't bother you? ü§∑

### ‚û°Ô∏è You are already using your future state management solution: React

## You want more and you don't want to write your own State management solution?

### ‚û°Ô∏è Let's take a look at libraries

---

# MobX

- state objects are _obserables_
- components are _observers_ by using the `@observer` annotation or the `useObserver` hook
- has _computed values_: lazily evaluated derived values

---

# MobX

`example code`

---

# MobX

- very un-opinionated: either modify state objects directly or use the safer "enforce actions" mode
- data-flow can be very un-react-like when a component far down the tree just modifies state shared with a component far up in the tree
  - this is in line with the mission of MobX: "to make React more reactive"
- asynconous actions can be handled in _reactions_
- any number of small MobX stores can co-exist in one application
- can also be used for local State with the `useLocalStore` hook (or just observable class properties)

---

# MobX-State-Tree

- builds on MobX
- very opinionetd
- requires definition of typesafe models (checked at runtime)
- per default, "enforced actions" mode is on, rejecting direct updates to the tree
- computed values usually in a direct _view_ on your model
- models have a _lifecycle_
- allows for use of action listeners and middlewares

---

# Redux

- unidirectional data-flow:
  - components _dispatch_ actions.
  - dispatched actions are passed together with the last state into a _reducer_ function to generate the new state
  - state should never be mutated, but always be created as a mutated copy
- _middleware_ can hook between dispatch and reducer to block actions and/or execute side-effects and dispatch further actions
- components are either _connected_ to the state using a HOC or use the _useSelector_ and _useDispatch_ hooks
- usually one Redux state per application

---

# Redux-Starter-Kit

- the new _redux-starter-kit_ package greatly reduces the amount of boilerplate and complexity of writing reducers

---

# Client-side State in Apollo-Client

- stores State in the Apollo Cache
- can be subscribed using GraphQL queries and the `@client` directive
- State modification by
  - either directly modifying the Cache
  - creating local Mutation resolvers (that modify the Cache)
- everything in Apollo-Client is normalized
  - so you will have many State types with only one instance and `id: 1`
- writing local Mutation resolvers feels a bit clunky
- no middlewares or other "best practice" to do asynchronous modifications
  - but of course you can always just write Mutations that mofify the Cache asynchronously

---

# So, what should _you_ use?

<Appear>

## Whatever works for you.

\*

</Appear>

---

# Time for Questions & Discussion
